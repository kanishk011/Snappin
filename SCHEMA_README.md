# Snappin Chat Application - Database Schema Documentation

**Version:** 1.0.0
**Last Updated:** 2025-10-28

This document describes the complete database schema for the Snappin chat application. This schema is used by both the mobile app (React Native) and web app.

---

## 📁 Files

- **`src/config/dbSchema.ts`** - TypeScript schema definitions (use this in React Native app)
- **`DATABASE_SCHEMA.json`** - JSON schema reference (use this for web app developers)
- **`SCHEMA_README.md`** - This documentation file
- **`firestore.rules`** - Firebase security rules

---

## 🗂️ Collection Structure

```
Firestore Database
│
├── users/                              (User profiles)
│   └── {userId}/                       (Document)
│
├── chats/                              (Personal conversations)
│   └── {chatId}/                       (Document: userId1_userId2)
│       └── messages/                   (Subcollection)
│           └── {messageId}/            (Document)
│
└── groups/                             (Group conversations)
    └── {groupId}/                      (Document: auto-generated)
        └── messages/                   (Subcollection)
            └── {messageId}/            (Document)
```

---

## 📊 Schema Details

### 1. **Users Collection** (`users`)

Stores user profile and authentication data.

**Document ID:** Firebase Auth UID (e.g., `wKAgXoTnQsMMCmV3pWohal4yexA3`)

**Fields:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `_id` | string | ✓ | User ID (same as document ID) |
| `name` | string | ✓ | Display name |
| `email` | string | ✗ | Email address |
| `avatar` | string (URL) | ✗ | Profile picture URL |
| `status` | enum | ✓ | `"online"` or `"offline"` |
| `lastSeen` | Timestamp | ✓ | Last active timestamp |
| `createdAt` | Timestamp | ✓ | Account creation time |
| `updatedAt` | Timestamp | ✓ | Last profile update |

**Example Document:**
```json
{
  "_id": "wKAgXoTnQsMMCmV3pWohal4yexA3",
  "name": "John Doe",
  "email": "john@example.com",
  "avatar": "https://firebasestorage.googleapis.com/.../avatar.jpg",
  "status": "online",
  "lastSeen": Timestamp(2025-10-28 10:29:00),
  "createdAt": Timestamp(2025-10-20 09:00:00),
  "updatedAt": Timestamp(2025-10-28 10:29:00)
}
```

---

### 2. **Chats Collection** (`chats`)

Stores personal one-on-one conversations.

**Document ID:** Format `userId1_userId2` (sorted alphabetically)
Example: `8DDXEVhIzDdddLAqWu2QPQJBlC73_wKAgXoTnQsMMCmV3pWohal4yexA3`

**Fields:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `_id` | string | ✓ | Chat ID (format: userId1_userId2) |
| `type` | string | ✓ | Always `"personal"` |
| `participants` | array&lt;string&gt; | ✓ | Array of 2 user IDs |
| `lastMessage` | string \| null | ✓ | Preview of last message |
| `lastMessageTime` | Timestamp \| null | ✓ | Time of last message |
| `createdAt` | Timestamp | ✓ | Chat creation time |
| `unreadCount` | object | ✗ | Unread count per user |

**unreadCount Structure:**
```typescript
{
  "[userId1]": number,
  "[userId2]": number
}
```

**Example Document:**
```json
{
  "_id": "8DDXEVhIzDdddLAqWu2QPQJBlC73_wKAgXoTnQsMMCmV3pWohal4yexA3",
  "type": "personal",
  "participants": [
    "8DDXEVhIzDdddLAqWu2QPQJBlC73",
    "wKAgXoTnQsMMCmV3pWohal4yexA3"
  ],
  "lastMessage": "Hi",
  "lastMessageTime": Timestamp(2025-10-28 10:29:00),
  "createdAt": Timestamp(2025-10-20 09:30:00),
  "unreadCount": {
    "8DDXEVhIzDdddLAqWu2QPQJBlC73": 2,
    "wKAgXoTnQsMMCmV3pWohal4yexA3": 0
  }
}
```

---

### 3. **Groups Collection** (`groups`)

Stores group conversations.

**Document ID:** Auto-generated by Firestore (e.g., `cKuMkZIArrdKlSJEd0I`)

**Fields:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `_id` | string | ✓ | Group ID (auto-generated) |
| `name` | string | ✓ | Group name |
| `avatar` | string (URL) | ✗ | Group picture URL |
| `description` | string | ✗ | Group description |
| `members` | array&lt;string&gt; | ✓ | Array of member user IDs |
| `admins` | array&lt;string&gt; | ✓ | Array of admin user IDs |
| `createdBy` | string | ✓ | Creator user ID |
| `lastMessage` | string \| null | ✓ | Preview of last message |
| `lastMessageTime` | Timestamp \| null | ✓ | Time of last message |
| `createdAt` | Timestamp | ✓ | Group creation time |
| `updatedAt` | Timestamp | ✓ | Last group update |
| `unreadCount` | object | ✗ | Unread count per member |

**Example Document:**
```json
{
  "_id": "cKuMkZIArrdKlSJEd0I",
  "name": "Project Team",
  "avatar": "https://firebasestorage.googleapis.com/.../group.jpg",
  "description": "Team discussion group",
  "members": ["user1", "user2", "user3"],
  "admins": ["user1"],
  "createdBy": "user1",
  "lastMessage": "Meeting at 3pm",
  "lastMessageTime": Timestamp(2025-10-28 10:29:00),
  "createdAt": Timestamp(2025-10-20 09:00:00),
  "updatedAt": Timestamp(2025-10-28 10:29:00),
  "unreadCount": {
    "user1": 0,
    "user2": 5,
    "user3": 3
  }
}
```

---

### 4. **Messages Subcollection** (`messages`)

Stores individual messages within chats and groups.

**Path:** `chats/{chatId}/messages` OR `groups/{groupId}/messages`
**Document ID:** Auto-generated by Firestore

**Fields:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `_id` | string | ✓ | Message ID (client-generated) |
| `text` | string | ✓ | Message text content |
| `createdAt` | Timestamp | ✓ | Message creation time |
| `user` | object | ✓ | Sender information (see below) |
| `image` | string (URL) \| null | ✗ | Image attachment URL |
| `video` | string (URL) \| null | ✗ | Video attachment URL |
| `audio` | string (URL) \| null | ✗ | Audio attachment URL |
| `document` | object \| null | ✗ | Document attachment (see below) |
| `replyTo` | object \| null | ✗ | Reply info (see below) |
| `readBy` | array&lt;object&gt; | ✓ | Read receipts (see below) |
| `edited` | boolean | ✗ | Whether message was edited |
| `editedAt` | Timestamp | ✗ | Edit timestamp |
| `deleted` | boolean | ✗ | Soft delete flag |
| `deletedAt` | Timestamp | ✗ | Delete timestamp |

**user Object:**
```typescript
{
  _id: string,      // Sender user ID
  name: string,     // Sender display name
  avatar?: string   // Sender avatar URL (optional)
}
```

**document Object:**
```typescript
{
  url: string,      // Download URL
  name: string,     // File name
  size?: number,    // File size in bytes
  type?: string     // MIME type (e.g., "application/pdf")
}
```

**replyTo Object:**
```typescript
{
  _id: string,      // Original message ID
  text: string,     // Original message text
  user: {
    _id: string,    // Original sender ID
    name: string    // Original sender name
  }
}
```

**readBy Array Item:**
```typescript
{
  userId: string,       // User ID who read the message
  timestamp: Timestamp  // When they read it
}
```

**Example Messages:**

**Text Message:**
```json
{
  "_id": "1000235702",
  "text": "Hi",
  "createdAt": Timestamp(2025-10-28 10:29:00),
  "user": {
    "_id": "wKAgXoTnQsMMCmV3pWohal4yexA3",
    "name": "John Doe",
    "avatar": "https://..."
  },
  "image": null,
  "video": null,
  "audio": null,
  "document": null,
  "replyTo": null,
  "readBy": [
    {
      "userId": "wKAgXoTnQsMMCmV3pWohal4yexA3",
      "timestamp": Timestamp(2025-10-28 10:29:00)
    },
    {
      "userId": "8DDXEVhIzDdddLAqWu2QPQJBlC73",
      "timestamp": Timestamp(2025-10-28 10:30:00)
    }
  ],
  "edited": false,
  "deleted": false
}
```

**Image Message:**
```json
{
  "_id": "1000235703",
  "text": "",
  "createdAt": Timestamp(2025-10-28 10:30:00),
  "user": {
    "_id": "user1",
    "name": "John"
  },
  "image": "https://firebasestorage.googleapis.com/.../image.jpg",
  "video": null,
  "audio": null,
  "document": null,
  "replyTo": null,
  "readBy": [...]
}
```

**Document Message:**
```json
{
  "_id": "1000235704",
  "text": "📄 contract.pdf",
  "createdAt": Timestamp(2025-10-28 10:31:00),
  "user": {
    "_id": "user1",
    "name": "John"
  },
  "image": null,
  "video": null,
  "audio": null,
  "document": {
    "url": "https://firebasestorage.googleapis.com/.../contract.pdf",
    "name": "contract.pdf",
    "size": 1048576,
    "type": "application/pdf"
  },
  "replyTo": null,
  "readBy": [...]
}
```

**Reply Message:**
```json
{
  "_id": "1000235705",
  "text": "That sounds good!",
  "createdAt": Timestamp(2025-10-28 10:32:00),
  "user": {
    "_id": "user2",
    "name": "Jane"
  },
  "replyTo": {
    "_id": "1000235702",
    "text": "Hi",
    "user": {
      "_id": "user1",
      "name": "John"
    }
  },
  "readBy": [...]
}
```

---

## 🔍 Querying Guidelines

### Get User's Chats
```typescript
// Query chats where user is a participant
collection('chats')
  .where('participants', 'array-contains', userId)
  .orderBy('lastMessageTime', 'desc')
```

### Get User's Groups
```typescript
// Query groups where user is a member
collection('groups')
  .where('members', 'array-contains', userId)
  .orderBy('lastMessageTime', 'desc')
```

### Get Messages in a Chat
```typescript
// Query messages in a chat, newest first
collection('chats/{chatId}/messages')
  .orderBy('createdAt', 'desc')
  .limit(50) // Pagination recommended
```

---

## 🔐 Security Rules Summary

See `firestore.rules` for complete security rules.

**Key Rules:**
- ✓ Users can read/write their own profile
- ✓ Users can read chats/groups they are part of
- ✓ Users can only update the `readBy` field in messages
- ✓ Users can delete their own messages
- ✓ Group creators can delete groups
- ✗ Users cannot delete their profiles

---

## 📈 Performance Considerations

### Indexes Required

1. **Chats:** `participants` + `lastMessageTime` (descending)
2. **Groups:** `members` + `lastMessageTime` (descending)
3. **Messages:** `createdAt` (descending)

Firebase will automatically prompt you to create these indexes when you first run queries.

### Best Practices

1. **Pagination:** Always use `.limit()` when fetching messages
2. **Unread Counts:** Stored in parent document to avoid counting subcollection items
3. **Soft Deletes:** Messages are marked as deleted, not removed (for data integrity)
4. **Read Receipts:** Updated incrementally as users read messages
5. **Attachments:** Only one type per message (image OR video OR document)

---

## 🔄 Data Consistency

### When Sending a Message

1. Add message to `messages` subcollection
2. Update parent chat/group:
   - Set `lastMessage`
   - Set `lastMessageTime`
   - Increment `unreadCount` for all participants except sender
3. Initialize `readBy` with sender's receipt

### When Reading Messages

1. Add user to message's `readBy` array
2. Decrement user's `unreadCount` in parent chat/group

### When Deleting a Message

1. Set `deleted: true` on message
2. Set `deletedAt` timestamp
3. Change `text` to "This message was deleted"
4. Do NOT remove the document

---

## 📝 Notes for Web Developers

1. **Chat IDs are deterministic:** Always sort user IDs alphabetically and join with `_`
   ```javascript
   const chatId = [userId1, userId2].sort().join('_');
   ```

2. **Message IDs are client-generated:** Use a unique ID generator
   ```javascript
   const messageId = Math.random().toString(36).substring(7);
   ```

3. **Timestamps:** Use Firebase `serverTimestamp()` for all timestamps
   ```javascript
   import { serverTimestamp } from 'firebase/firestore';
   ```

4. **Real-time Updates:** Use `onSnapshot` for all subscriptions
   ```javascript
   onSnapshot(query, (snapshot) => {
     // Handle updates
   });
   ```

5. **Error Handling:** All operations should have try-catch blocks

---

## 🚀 Getting Started (Web App)

1. Import the schema: Use `DATABASE_SCHEMA.json` as reference
2. Set up Firebase config
3. Implement authentication
4. Use the provided query patterns
5. Follow the security rules

---

## 📞 Support

For questions about the schema, contact the mobile app development team or refer to:
- `src/services/firestoreService.ts` - Complete implementation examples
- `src/config/dbSchema.ts` - TypeScript type definitions
- `firestore.rules` - Security rule implementations

---

**Schema Version:** 1.0.0
**Compatible with:** React Native 0.82.0, Web (Firebase 9+)
